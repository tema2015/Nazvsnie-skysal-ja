name: Build Android Emulator APK
on: [workflow_dispatch]
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - uses: actions/setup-java@v4
      with:
        distribution: temurin
        java-version: 17
        
    - uses: android-actions/setup-android@v3
    
    - name: Accept licenses
      run: yes | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --licenses
      
    - name: Create project
      run: |
        mkdir -p android-app/{app/src/main/{java/com/emulator/android1emu,res/layout},build.gradle}
        
    - name: MainActivity
      run: |
        cat>android-app/app/src/main/java/com/emulator/android1emu/MainActivity.java<<'EOF'
package com.emulator.android1emu;
import android.app.Activity;
import android.os.Bundle;
import android.view.View;
import android.widget.Button;
import android.widget.TextView;
public class MainActivity extends Activity{
  @Override
  protected void onCreate(Bundle s){
    super.onCreate(s);
    setContentView(R.layout.main);
    Button b=(Button)findViewById(1);
    TextView t=(TextView)findViewById(2);
    b.setOnClickListener(new View.OnClickListener(){
      public void onClick(View v){
        t.setText("âœ… Android 1.0 Ð­ÐœÐ£Ð›Ð¯Ð¢ÐžÐ \nðŸ”Œ ADB: localhost:5555\nðŸ“± Scrcpy Ð³Ð¾Ñ‚Ð¾Ð²");
      }
    });
  }
}
EOF
        
    - name: Layout
      run: |
        cat>android-app/app/src/main/res/layout/main.xml<<'EOF'
<?xml version="1.0" encoding="utf-8"?>
<LinearLayout xmlns:android="http://schemas.android.com/apk/res/android"
  android:layout_width="match_parent"
  android:layout_height="match_parent"
  android:orientation="vertical"
  android:padding="20dp">
  <Button android:id="@+id/start"
    android:layout_width="match_parent"
    android:layout_height="wrap_content"
    android:text="ðŸš€ Ð—ÐÐŸÐ£Ð¡Ð¢Ð˜Ð¢Ð¬ ANDROID 1.0"/>
  <TextView android:id="@+id/status"
    android:layout_width="match_parent"
    android:layout_height="wrap_content"
    android:text="Ð–ÐœÐ˜ ÐšÐÐžÐŸÐšÐ£!"
    android:textSize="18sp"
    android:gravity="center"
    android:layout_marginTop="20dp"/>
</LinearLayout>
EOF
        
    - name: Manifest
      run: |
        cat>android-app/app/src/main/AndroidManifest.xml<<'EOF'
<?xml version="1.0" encoding="utf-8"?>
<manifest xmlns:android="http://schemas.android.com/apk/res/android"
  package="com.emulator.android1emu">
  <application android:label="Android 1.0 Emulator">
    <activity android:name=".MainActivity"
      android:exported="true">
      <intent-filter>
        <action android:name="android.intent.action.MAIN"/>
        <category android:name="android.intent.category.LAUNCHER"/>
      </intent-filter>
    </activity>
  </application>
</manifest>
EOF
        
    - name: Gradle files
      run: |
        cat>android-app/build.gradle<<'EOF'
buildscript {
  repositories { google() mavenCentral() }
  dependencies {
    classpath 'com.android.tools.build:gradle:8.1.4'
  }
}
EOF
        
        cat>android-app/settings.gradle<<'EOF'
include ':app'
EOF
        
        cat>android-app/gradle.properties<<'EOF'
android.useAndroidX=true
EOF
        
        cat>android-app/app/build.gradle<<'EOF'
apply plugin: 'com.android.application'
android {
  compileSdk 34
  defaultConfig {
    applicationId "com.emulator.android1emu"
    minSdk 21
    targetSdk 34
    versionCode 1
    versionName "1.0"
  }
  buildTypes {
    release { minifyEnabled false }
  }
}
EOF
        
    - name: Build APK
      run: |
        cd android-app
        $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager "build-tools;34.0.0"
        gradle wrapper
        ./gradlew assembleRelease
        
    - name: Upload
      uses: actions/upload-artifact@v4
      with:
        name: Android1-Emulator-APK
        path: android-app/app/build/outputs/apk/release/app-release.apk
