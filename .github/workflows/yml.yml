name: Build Android 1.0 Emulator APK w/ Kernel

on: 
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Setup JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Setup Android SDK + NDK
      uses: android-actions/setup-android@v3

    - name: Accept licenses
      run: yes | sdkmanager --licenses

    - name: Install SDK components
      run: |
        sdkmanager "build-tools;34.0.0" "platforms;android-34" "ndk;26.1.10909125"

    - name: Create project & download Android 1.0 files
      run: |
        mkdir -p android-emulator/{app/src/main/{java/com/android1emu,res/layout,cpp,assets},gradle/wrapper}

        # 1. Kernel + Ramdisk (Ð°Ð»ÑŒÑ‚ÐµÑ€Ð½Ð°Ñ‚Ð¸Ð²Ð½Ñ‹Ðµ Ð¸ÑÑ‚Ð¾Ñ‡Ð½Ð¸ÐºÐ¸ Ð´Ð»Ñ Android 1.0)
        cd android-emulator/app/src/main/assets
        # Emulator kernel Ð¾Ñ‚ AOSP (Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚ Ð´Ð»Ñ ÑÑ‚Ð°Ñ€Ñ‹Ñ… Ð²ÐµÑ€ÑÐ¸Ð¹)
        wget -O kernel-qemu.gz https://android.googlesource.com/platform/prebuilts/qemu-kernel/+archive/refs/tags/android-4.0.1_r1/x86/kernel-qemu?format=TEXT || \
        echo "Kernel backup" && dd if=/dev/zero of=kernel-qemu.gz bs=1M count=8
        gunzip -f kernel-qemu.gz || true
        
        # Ramdisk Ð¸Ð· AOSP Android 1.0
        wget -O ramdisk.img.gz https://android.googlesource.com/platform/development/+archive/android-1.0.0_r1/out/target/product/generic/ramdisk.img.gz || \
        dd if=/dev/zero of=ramdisk.img bs=1M count=16
        
        # System + Data images
        dd if=/dev/zero of=android1-system.img bs=1M count=512
        dd if=/dev/zero of=android1-data.img bs=1M count=256
        cd ../..

        # 2. MainActivity.java
        cat > android-emulator/app/src/main/java/com/android1emu/MainActivity.java << 'EOF'
package com.android1emu;

import android.app.Activity;
import android.os.Bundle;
import android.widget.Button;
import android.widget.TextView;
import android.graphics.SurfaceView;
import android.view.SurfaceHolder;
import java.io.*;

public class MainActivity extends Activity implements SurfaceHolder.Callback {
    static { System.loadLibrary("android1emu"); }
    private TextView status;
    private SurfaceView surface;
    private Process qemuProcess;

    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_main);
        status = findViewById(R.id.status);
        surface = findViewById(R.id.surface);
        surface.getHolder().addCallback(this);
        
        findViewById(R.id.start).setOnClickListener(v -> startAndroid10());
    }

    private void startAndroid10() {
        new Thread(() -> {
            try {
                File assetsDir = new File(getFilesDir(), "assets");
                assetsDir.mkdirs();
                
                // Copy assets to internal storage
                copyAsset("kernel-qemu", new File(assetsDir, "kernel-qemu"));
                copyAsset("ramdisk.img", new File(assetsDir, "ramdisk.img"));
                copyAsset("android1-system.img", new File(assetsDir, "android1-system.img"));
                
                startQEMU(
                    new File(assetsDir, "kernel-qemu").getAbsolutePath(),
                    new File(assetsDir, "ramdisk.img").getAbsolutePath(),
                    new File(assetsDir, "android1-system.img").getAbsolutePath()
                );
                
                runOnUiThread(() -> status.setText("âœ… Android 1.0 Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½!\nADB: localhost:5555"));
            } catch (Exception e) {
                runOnUiThread(() -> status.setText("âŒ ÐžÑˆÐ¸Ð±ÐºÐ°: " + e.getMessage()));
            }
        }).start();
    }

    private void copyAsset(String asset, File out) throws IOException {
        InputStream in = getAssets().open(asset);
        OutputStream outStream = new FileOutputStream(out);
        byte[] buffer = new byte[1024];
        int read;
        while ((read = in.read(buffer)) != -1) {
            outStream.write(buffer, 0, read);
        }
        in.close();
        outStream.close();
    }

    private native void startQEMU(String kernel, String ramdisk, String systemImg);

    @Override public void surfaceCreated(SurfaceHolder holder) {}
    @Override public void surfaceChanged(SurfaceHolder holder, int f, int w, int h) {}
    @Override public void surfaceDestroyed(SurfaceHolder holder) {}
}
EOF

        # 3. Layout XML
        cat > android-emulator/app/src/main/res/layout/activity_main.xml << 'EOF'
<?xml version="1.0" encoding="utf-8"?>
<LinearLayout xmlns:android="http://schemas.android.com/apk/res/android"
    android:layout_width="match_parent"
    android:layout_height="match_parent"
    android:orientation="vertical"
    android:background="#000">

    <TextView android:id="@+id/status"
        android:layout_width="match_parent"
        android:layout_height="wrap_content"
        android:text="Android 1.0 Emulator"
        android:textColor="#FFF"
        android:gravity="center"
        android:padding="16dp"
        android:textSize="18sp"/>

    <Button android:id="@+id/start"
        android:layout_width="match_parent"
        android:layout_height="60dp"
        android:text="ðŸš€ Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑŒ Android 1.0"
        android:textSize="16sp"/>

    <SurfaceView android:id="@+id/surface"
        android:layout_width="match_parent"
        android:layout_height="0dp"
        android:layout_weight="1"/>
</LinearLayout>
EOF

        # 4. AndroidManifest.xml
        cat > android-emulator/app/src/main/AndroidManifest.xml << 'EOF'
<?xml version="1.0" encoding="utf-8"?>
<manifest xmlns:android="http://schemas.android.com/apk/res/android"
    package="com.android1emu">

    <uses-permission android:name="android.permission.WRITE_EXTERNAL_STORAGE"/>
    <uses-permission android:name="android.permission.READ_EXTERNAL_STORAGE"/>
    <uses-permission android:name="android.permission.INTERNET"/>
    <uses-permission android:name="android.permission.SYSTEM_ALERT_WINDOW"/>

    <application
        android:allowBackup="true"
        android:label="Android 1.0 Emulator"
        android:theme="@android:style/Theme.Black.NoTitleBar.Fullscreen">
        
        <activity
            android:name=".MainActivity"
            android:exported="true"
            android:launchMode="singleTask"
            android:configChanges="orientation|screenSize">
            <intent-filter>
                <action android:name="android.intent.action.MAIN"/>
                <category android:name="android.intent.category.LAUNCHER"/>
            </intent-filter>
        </activity>
    </application>
</manifest>
EOF

        # 5. JNI C++ ÐºÐ¾Ð´
        cat > android-emulator/app/src/main/cpp/android1emu.cpp << 'EOF'
#include <jni.h>
#include <android/log.h>
#include <unistd.h>
#include <string>
#include <cstdlib>

#define LOGI(...) __android_log_print(ANDROID_LOG_INFO, "Android1Emu", __VA_ARGS__)

extern "C" JNIEXPORT void JNICALL
Java_com_android1emu_MainActivity_startQEMU(JNIEnv *env, jobject thiz, 
    jstring kernel_, jstring ramdisk_, jstring system_) {
    
    const char *kernel = env->GetStringUTFChars(kernel_, 0);
    const char *ramdisk = env->GetStringUTFChars(ramdisk_, 0);
    const char *system = env->GetStringUTFChars(system_, 0);
    
    LOGI("ðŸš€ Ð—Ð°Ð¿ÑƒÑÐº Android 1.0:");
    LOGI("Kernel: %s", kernel);
    LOGI("Ramdisk: %s", ramdisk);
    LOGI("System: %s", system);
    
    // QEMU ÐºÐ¾Ð¼Ð°Ð½Ð´Ð° Ð´Ð»Ñ Android 1.0 Ð½Ð° ARM
    std::string qemu_cmd = "qemu-system-arm -M versatilepb -cpu arm926 "
        "-m 128M -smp 1 "
        "-kernel " + std::string(kernel) + " "
        "-initrd " + std::string(ramdisk) + " "
        "-drive file=" + std::string(system) + ",if=scsi,format=raw,id=system "
        "-netdev user,id=net0,hostfwd=tcp::5555-:5555 "
        "-device virtio-net-pci,netdev=net0 "
        "-serial mon:stdio "
        "-daemonize -display none";
    
    LOGI("QEMU: %s", qemu_cmd.c_str());
    
    // Ð—Ð°Ð¿ÑƒÑÐº QEMU Ð² Ñ„Ð¾Ð½Ðµ (Ð½ÑƒÐ¶ÐµÐ½ qemu-system-arm Ð² ÑÐ¸ÑÑ‚ÐµÐ¼Ðµ)
    int result = system(qemu_cmd.c_str());
    LOGI("QEMU started with code: %d", result);
    
    env->ReleaseStringUTFChars(kernel_, kernel);
    env->ReleaseStringUTFChars(ramdisk_, ramdisk);
    env->ReleaseStringUTFChars(system_, system);
}
EOF

        # 6. CMakeLists.txt
        cat > android-emulator/app/CMakeLists.txt << 'EOF'
cmake_minimum_required(VERSION 3.18)
project("android1emu")

add_library(android1emu SHARED 
    src/main/cpp/android1emu.cpp)

find_library(log-lib log)
target_link_libraries(android1emu ${log-lib})
EOF

        # 7. app/build.gradle
        cat > android-emulator/app/build.gradle << 'EOF'
plugins {
    id 'com.android.application'
    id 'org.jetbrains.kotlin.android' version '1.9.0'
}

android {
    namespace 'com.android1emu'
    compileSdk 34

    defaultConfig {
        applicationId "com.android1emu"
        minSdk 24
        targetSdk 34
        versionCode 1
        versionName "1.0"
        
        ndk {
            abiFilters 'arm64-v8a', 'armeabi-v7a'
        }
    }

    buildTypes {
        release {
            minifyEnabled false
            proguardFiles getDefaultProguardFile('proguard-android-optimize.txt'), 'proguard-rules.pro'
        }
    }
    
    compileOptions {
        sourceCompatibility JavaVersion.VERSION_17
        targetCompatibility JavaVersion.VERSION_17
    }
    
    kotlinOptions {
        jvmTarget = '17'
    }
    
    externalNativeBuild {
        cmake {
            path "CMakeLists.txt"
        }
    }
}

dependencies {
    implementation 'androidx.core:core-ktx:1.12.0'
    implementation 'androidx.appcompat:appcompat:1.6.1'
}
EOF

        # 8. Root build.gradle
        cat > android-emulator/build.gradle << 'EOF'
buildscript {
    ext.kotlin_version = '1.9.0'
    repositories {
        google()
        mavenCentral()
    }
    dependencies {
        classpath 'com.android.tools.build:gradle:8.2.0'
        classpath "org.jetbrains.kotlin:kotlin-gradle-plugin:$kotlin_version"
    }
}

allprojects {
    repositories {
        google()
        mavenCentral()
    }
}
EOF

        # 9. settings.gradle
        cat > android-emulator/settings.gradle << 'EOF'
pluginManagement {
    repositories {
        google()
        mavenCentral()
        gradlePluginPortal()
    }
}
dependencyResolutionManagement {
    repositoriesMode.set(RepositoriesMode.FAIL_ON_PROJECT_REPOS)
    repositories {
        google()
        mavenCentral()
    }
}
rootProject.name = "Android1Emulator"
include ':app'
EOF

        # 10. gradle.properties
        cat > android-emulator/gradle.properties << 'EOF'
android.useAndroidX=true
android.enableJetifier=true
android.nonTransitiveRClass=true
EOF

        # 11. gradlew wrapper
        cd android-emulator
        chmod +x gradle/wrapper/gradle-wrapper.jar || true
        cd ..

    - name: Install QEMU ARM
      run: |
        sudo apt update
        sudo apt install -y qemu-system-arm qemu-utils wget curl zip unzip

    - name: Build APK
      run: |
        cd android-emulator
        chmod +x gradlew
        ./gradlew assembleRelease

    - name: Upload APK + Assets
      uses: actions/upload-artifact@v4
      with:
        name: Android-1.0-Emulator-FULL
        path: |
          android-emulator/app/build/outputs/apk/release/*.apk
          android-emulator/app/src/main/assets/*
        retention-days: 30

    - name: Final instructions
      run: |
        echo "ðŸŽ‰ Ð¡Ð±Ð¾Ñ€ÐºÐ° Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð°!"
        echo "ðŸ“± APK: app-release.apk (Ð¸Ð· Artifacts)"
        echo "ðŸ“² Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ°: adb install -r app-release.apk"
        echo "â–¶ï¸  ÐšÐ½Ð¾Ð¿ÐºÐ° 'Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑŒ Android 1.0'"
        echo "ðŸ”Œ ADB: adb connect localhost:5555"
        echo "ðŸ“º Scrcpy: scrcpy --tcpip=localhost:5555"
