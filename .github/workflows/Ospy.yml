name: PyOS Installer ISO
on: [push, workflow_dispatch]
jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
    
    - name: Create PyOS Installer
      run: |
        mkdir -p pyos/{boot/grub,pyos}
        
        # GRUB config
        cat > pyos/boot/grub/grub.cfg << 'EOF'
        menuentry "PyOS Installer" {
            linux /pyos/vmlinuz root=/dev/sr0 quiet install
            initrd /pyos/initrd.gz
        }
        menuentry "PyOS Live" {
            linux /pyos/vmlinuz root=/dev/sr0 quiet
            initrd /pyos/initrd.gz  
        }
        EOF
        
        # Скачиваем минимальный kernel+initrd
        wget -q https://github.com/cavaliercoder/grub2iso/raw/master/test/vmlinuz -O pyos/vmlinuz
        wget -q https://github.com/cavaliercoder/grub2iso/raw/master/test/initrd.gz -O pyos/initrd.gz
        
        # PyOS + установщик
        cat > pyos/pyos.py << 'EOF'
#!/bin/bash
echo "=== PyOS v2.0 Installer ==="
echo "1) Установить на диск  2) Live режим"
read -p "Выбор: " choice

if [ "$choice" = "1" ]; then
  echo "Диски:"; lsblk
  read -p "Диск для установки (sda): " disk
  mkfs.ext4 /dev/${disk}1 || mkfs.ext4 /dev/${disk}
  mkdir /mnt; mount /dev/${disk}1 /mnt
  mkdir -p /mnt/pyos /mnt/boot/grub
  cp -r /cdrom/pyos/* /mnt/pyos/
  cat > /mnt/boot/grub/grub.cfg << GRUB
menuentry "PyOS" { linux /pyos/vmlinuz root=/dev/sda1; initrd /pyos/initrd.gz }
GRUB
  umount /mnt
  echo "✓ УСТАНОВЛЕНО на $disk! Перезагрузка..."
  sleep 3; reboot
fi
python3 /cdrom/pyos/editor.py
EOF
        
        chmod +x pyos/pyos.py
        
        # PyOS редактор
        cat > pyos/editor.py << 'EOF'
import tkinter as tk
from tkinter import scrolledtext
import os
tk.Tk().title("PyOS v2.0"); e=scrolledtext.ScrolledText(bg="#000",fg="#0f0")
e.pack(fill="both",expand=1); e.insert("end","# PyOS установлен!\nimport os\nprint(os.listdir('/'))\n")
tk.Button(tk.Tk(),text="RUN",command=lambda:exec(e.get("1.0","end"))).pack()
tk.Tk().mainloop()
EOF
        
        # GRUB + ISO
        apt-get update -qq
        apt-get install -y -qq grub-pc-bin xorriso
        grub-mkrescue -o PyOS-Installer.iso pyos/
    
    - uses: actions/upload-artifact@v4
      with:
        name: PyOS-Installer
        path: PyOS-Installer.iso
