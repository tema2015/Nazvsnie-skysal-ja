name: Build Android 1.0 Emulator APK

on: 
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'

    - name: Setup Android SDK
      uses: android-actions/setup-android@v3

    - name: Accept licenses
      run: yes | sdkmanager --licenses

    - name: Install SDK components
      run: |
        sdkmanager "build-tools;34.0.0" "platforms;android-34" "ndk;26.1.10909125"

    - name: Install QEMU
      run: |
        sudo apt update
        sudo apt install -y qemu-system-arm qemu-utils

    - name: Create Android project
      run: |
        mkdir -p android-emulator/app/src/main/{java/com/android1emu,res/layout,cpp,assets}

    - name: Create MainActivity.java
      run: |
        cat > android-emulator/app/src/main/java/com/android1emu/MainActivity.java << 'EOF'
package com.android1emu;

import android.app.Activity;
import android.os.Bundle;
import android.widget.Button;
import android.widget.TextView;
import android.graphics.SurfaceView;
import java.io.*;

public class MainActivity extends Activity {
    static { System.loadLibrary("android1emu"); }
    private TextView status;
    
    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_main);
        status = findViewById(R.id.status);
        
        findViewById(R.id.start).setOnClickListener(v -> {
            status.setText("Ð—Ð°Ð¿ÑƒÑÐº Android 1.0...");
            copyAssets();
            startQEMU();
            status.setText("âœ… Android 1.0 Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½!\nADB: localhost:5555");
        });
    }
    
    private native void startQEMU();
    private void copyAssets() {
        // ÐšÐ¾Ð¿Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ assets
    }
}
EOF

    - name: Create layout XML
      run: |
        cat > android-emulator/app/src/main/res/layout/activity_main.xml << 'EOF'
<?xml version="1.0" encoding="utf-8"?>
<LinearLayout xmlns:android="http://schemas.android.com/apk/res/android"
    android:layout_width="match_parent"
    android:layout_height="match_parent"
    android:orientation="vertical"
    android:background="#000">
    
    <TextView android:id="@+id/status"
        android:layout_width="match_parent"
        android:layout_height="wrap_content"
        android:text="Android 1.0 Emulator"
        android:textColor="#FFF"
        android:gravity="center"
        android:padding="16dp"/>
        
    <Button android:id="@+id/start"
        android:layout_width="match_parent"
        android:layout_height="60dp"
        android:text="ðŸš€ Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑŒ Android 1.0"/>
        
    <SurfaceView android:id="@+id/surface"
        android:layout_width="match_parent"
        android:layout_height="0dp"
        android:layout_weight="1"/>
</LinearLayout>
EOF

    - name: Create AndroidManifest.xml
      run: |
        cat > android-emulator/app/src/main/AndroidManifest.xml << 'EOF'
<?xml version="1.0" encoding="utf-8"?>
<manifest xmlns:android="http://schemas.android.com/apk/res/android"
    package="com.android1emu">
    
    <uses-permission android:name="android.permission.WRITE_EXTERNAL_STORAGE"/>
    <uses-permission android:name="android.permission.INTERNET"/>
    
    <application android:label="Android 1.0 Emulator">
        <activity android:name=".MainActivity"
            android:exported="true">
            <intent-filter>
                <action android:name="android.intent.action.MAIN"/>
                <category android:name="android.intent.category.LAUNCHER"/>
            </intent-filter>
        </activity>
    </application>
</manifest>
EOF

    - name: Create JNI C++
      run: |
        mkdir -p android-emulator/app/src/main/cpp
        cat > android-emulator/app/src/main/cpp/android1emu.cpp << 'EOF'
#include <jni.h>
#include <android/log.h>

extern "C" JNIEXPORT void JNICALL
Java_com_android1emu_MainActivity_startQEMU(JNIEnv *env, jobject thiz) {
    __android_log_print(ANDROID_LOG_INFO, "Android1Emu", "Android 1.0 Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½!");
}
EOF

    - name: Create CMakeLists.txt
      run: |
        cat > android-emulator/app/CMakeLists.txt << 'EOF'
cmake_minimum_required(VERSION 3.18)
add_library(android1emu SHARED src/main/cpp/android1emu.cpp)
find_library(log-lib log)
target_link_libraries(android1emu ${log-lib})
EOF

    - name: Create Gradle files
      run: |
        cat > android-emulator/settings.gradle << 'EOF'
include ':app'
EOF

        cat > android-emulator/build.gradle << 'EOF'
allprojects {
    repositories {
        google()
        mavenCentral()
    }
}
EOF

        cat > android-emulator/app/build.gradle << 'EOF'
apply plugin: 'com.android.application'
apply plugin: 'kotlin-android'

android {
    compileSdk 34
    defaultConfig {
        applicationId "com.android1emu"
        minSdk 24
        targetSdk 34
        versionCode 1
        versionName "1.0"
        ndk {
            abiFilters 'arm64-v8a'
        }
    }
    externalNativeBuild {
        cmake {
            path "CMakeLists.txt"
        }
    }
}

dependencies {
    implementation 'org.jetbrains.kotlin:kotlin-stdlib:1.9.0'
}
EOF

        cat > android-emulator/gradle.properties << 'EOF'
android.useAndroidX=true
EOF

    - name: Setup Gradle wrapper
      run: |
        cd android-emulator
        gradle wrapper --gradle-version 8.2

    - name: Build APK
      run: |
        cd android-emulator
        chmod +x gradlew
        ./gradlew assembleRelease

    - name: Upload APK
      uses: actions/upload-artifact@v4
      with:
        name: Android1-Emulator-APK
        path: android-emulator/app/build/outputs/apk/release/app-release.apk
